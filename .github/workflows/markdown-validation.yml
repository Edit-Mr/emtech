name: Markdown File Validation

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    validate-markdown:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Validate Markdown Files
              run: |
                  #!/bin/bash
                  set -e

                  # Function to validate a single markdown file
                  validate_markdown() {
                      local file="$1"
                      local errors=0

                      echo "Validating $file"

                      # Check if file exists
                      if [ ! -f "$file" ]; then
                          echo "Error: File $file does not exist"
                          return 1
                      fi

                      # Extract front matter
                      front_matter=$(sed -n '/^---$/,/^---$/p' "$file")

                      # Check for front matter
                      if [ -z "$front_matter" ]; then
                          echo "Error in $file: No front matter found"
                          ((errors++))
                      fi

                      # Check for date
                      if ! echo "$front_matter" | grep -qE 'date:\s*[0-9]{4}-[0-9]{2}-[0-9]{2}'; then
                          echo "Error in $file: No valid date found"
                          ((errors++))
                      fi

                      # Check for tags or categories
                      if ! echo "$front_matter" | grep -qE 'tags:\s*\[.*\]|categories:\s*\[.*\]'; then
                          echo "Error in $file: No tags or categories found"
                          ((errors++))
                      fi

                      # Check for H1 title
                      if ! grep -qE '^# ' "$file"; then
                          echo "Error in $file: No H1 title found"
                          ((errors++))
                      fi

                      # Check for {{notice}} and {{noticed}} balance
                      notice_count=$(grep -c '{{notice}}' "$file")
                      noticed_count=$(grep -c '{{noticed}}' "$file")

                      if [ "$notice_count" -gt 0 ] && [ "$notice_count" != "$noticed_count" ]; then
                          echo "Error in $file: Mismatched {{notice}} and {{noticed}} counts"
                          ((errors++))
                      fi

                      return $errors
                  }

                  # Main validation script
                  total_errors=0
                  markdown_files=$(find ./post -type f -name "*.md")

                  if [ -z "$markdown_files" ]; then
                      echo "No markdown files found in ./post directory"
                      exit 1
                  fi

                  for file in $markdown_files; do
                      validate_markdown "$file"
                      file_errors=$?
                      total_errors=$((total_errors + file_errors))
                  done

                  if [ "$total_errors" -gt 0 ]; then
                      echo "Validation failed with $total_errors errors"
                      exit 1
                  else
                      echo "All markdown files passed validation!"
                      exit 0
